<div class=markdown-body>

##  들어가며

현재 진행 중인 프로젝트에 테스트 환경을 어떻게 가져갈지 고민이 생겼습니다.  
“운영 환경이랑 최대한 비슷하게 테스트를 돌리고 싶은데, 속도/비용/복잡도는 어디까지 감수할 수 있을까?”

언젠가는 팀에 도입하게 될텐데 "어떻게 설계하는 게 깔끔할까?”를 미리 고민해보고자 합니다.

이 포스팅에서는 다음 내용을 다룹니다.
- 여러 테스트 환경 옵션 중에서 왜 `Testcontainers`를 선택하게 되었는지?  
- `Testcontainers`를 어떤 방식으로 적용할지 (`@Profile`/ 상속 / 기타 어노테이션)
- `Testcontainers` 위에서 초기 데이터 세팅 전략 + 테스트 후 클린업 전략을 어떻게 생각해봤는지
  - 특히 테스트 클린업 전략을 `@Transactional`으로 선택했을 때 발생할 수 있는 문제 (Lazy 로딩, Dirty Checking)

“정답”을 말한다기보다는,
저처럼 도입 전에 미리 실험해보고 싶은 분들이 생각할 포인트 목록 정도로 봐주시면 좋겠습니다.

## 본문

### 왜 `Testcontainers`를 선택하게 되었는지?  

먼저, “왜 굳이 `Testcontainers`까지 써볼까?”를 정리해봤습니다.

#### [환경 불일치 문제]
일반적으로 이런 구조 많이 쓰잖아요.
- 운영: MySQL, Redis, ...
- 테스트: H2 / in-memory DB, Mockito 기반의 Stub …

이렇게 가다 보면
- H2에서는 통과하는 쿼리가 MySQL에선 인덱스/제약조건/타입 차이로 문제를 일으키고,
- 테스트에서는 통과하는 시나리오가 배포 후에 통과하지 못하는 케이스가 발생하고요.

결괴적으로, "테스트는 있는데 그 테스트를 신뢰할 수 없는 상태"가 되어버리는 거죠.

테스트 환경 구성 방식은 여러 가지가 있을 텐데,
그 중에서도 특히 중요하게 보고 싶은 기준은 두 가지 정도로 정리해볼 수 있을 것 같습니다.

- 신뢰도
  - 운영과 최대한 비슷한 DB/외부 서비스를 사용할 수 있는가?
- 작성·유지보수 난이도
  - 테스트 작성하는 개발자가 얼마나 많은 내용을 이해하고 있어야 하는가?

이제, “실제 우리 팀에 도입한다면 어떤 선택을 할 것인가?”를 전제로 한 번 생각해보겠습니다.


### 테스트 환경 옵션들 간단 비교

각자 로컬에 Docker(MySQL)를 띄워서 사용
- 장점
  - 네트워크 지연 없이 빠르게 테스트를 돌릴 수 있음.
  - 스키마나 데이터를 마음껏 깨부수면서 실험해도 다른 사람에게 영향이 없음.
- 단점
  - 개발자마다 설치 방식, 버전, 설정이 제각각이 될 수 있음.
  - 신규 입사자 온보딩 시, 환경 세팅이 큰 부담(일종의 지옥)이 될 수 있음.

“지금처럼 혼자 PoC 해보는 상황”에서는 꽤 괜찮은 선택이지만,
“팀의 공식 패턴으로 채택한다”라고 생각하면 아쉬운 점이 적지 않습니다.

**[테스트(test)·개발(dev) 인프라 사용]**
- 장점
  - 별도 인프라를 따로 만들 필요 없이, 기존 dev DB를 그대로 활용할 수 있음.
- 단점
  - 테스트 데이터와 dev 데이터가 섞이면서 데이터 무결성 문제가 발생할 위험이 있음.
  - 네트워크 비용 및 속도 이슈가 생길 수 있음.
  - 테스트 실행 때문에 dev 환경 자체가 점점 지저분해질 수 있음.

개인적으로는 “테스트 환경은 다른 환경과 최대한 깔끔하게 격리하자”는 쪽에 무게를 두고 있어서,
이 방식은 현실적인 선택지로 보긴 어렵다고 판단했습니다.

</div>
